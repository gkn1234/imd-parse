## imd 二进制分析

### 乐曲时间
- 位数：4 * 8
- 机制：毫秒数十进制转十六进制后取反
- 实例：122280 => 00 01 DD A8 => A8 DD 01 00
```
A8 DD 01 00
```

### 时间线数量(节拍数)
- 位数：4 * 8
- 机制：
  + 先根据 bpm 算出每拍长度：`beatTime = 60000 / bpm`
  + 之后用乐曲时间除以每拍长度，向上取整后再加一(兼顾首尾)：`result = Math.round(songTime / beatTime) + 1`
  + 将结果的十进制数转十六进制后取反
- 实例：122280ms / 170bpm => 每拍长度 352.941ms，共 Math.round(122280 / (60000 / 170)) + 1 = 348 => 00 00 01 5C => 5C 01 00 00
```
5C 01 00 00
```

### 时间戳(每行)
#### 时间线节点
- 位数：4 * 8
- 机制：
  + 第1行为 0
  + 每一行均匀地加上每拍长度，向下取整。
  + 最后一行可能会超出歌曲时间，但是依然保留。
  + 每一行的十进制数转十六进制后取反。
- 实例：
  + 以 122280ms / 170bpm 的谱面为例，60000 / 170 ≈ 352.941
  + 第1行为 0 => 00 00 00 00
  + 第2行为 352.941 ≈ 352 => 00 00 01 60 => 60 01 00 00
  + ...
  + 第348行为 122470.588 ≈ 122470 => 00 01 DE 66 => 66 DE 01 00

#### BPM
- 位数：8 * 8
- 机制：bpm 数转换为 64 位浮点数，注意这里不取返
- 实例：189bpm => 00 00 00 00 00 A0 67 40
- 算法如下
```js
a = new Uint8Array(8)

// 第二个参数为偏移的字节量，第三个参数为从 a 中截取的字节长度
b = new DataView(a.buffer, 0, 8)

// 第一个参数为写入偏移量，第二个参数为十进制数字
b.setFloat64(0, 189, true)
```

#### 例子
以 122280ms / 170bpm 的谱面为例
```
00 00 00 00 00 00 00 00 00 40 63 40 # 1
60 01 00 00 00 00 00 00 00 40 63 40 # 2
C1 02 00 00 00 00 00 00 00 40 63 40 # 3
...
66 DE 01 00 00 00 00 00 00 40 63 40 # 348
```

### 固定位
- 位数：2 * 8
```
03 03
```

### 谱面行数
- 位数：4 * 8
- 机制：行数十进制转十六进制后取反
- 实例：1121 => 00 00 04 61 => 61 04 00 00
```
61 04 00 00
```

### 谱面(每行)
#### 键型
- 位数：2 * 8
- 0 - 4 位属性：
  + 0 非折线
  + 6 折线开头
  + 2 折线中段
  + A 折线结尾
- 5 - 8 位属性：
  + 0 单点
  + 1 滑动
  + 2 长按
- 9 - 16位：00

#### 时间戳
- 位数：4 * 8
- 机制：键位时间毫秒数的十进制数转十六进制后取反
- 实例：1058 => 00 00 04 22 => 22 04 00 00

#### 键位
- 位数：1 * 8
- 实例：
  + 00 最左
  + ...
  + 03 4K 最右
  + 04 5K 最右
  + ...

#### 动作属性
- 位数：4 * 8
- 单点类：00 00 00 00
- 滑动类：滑动的轨道数十进制数转十六进制后取反
  + 右滑 1 轨：1 => 00 00 00 01 => 01 00 00 00
  + 左滑 1 轨：-1 => FF FF FF FF
  + 左滑 2 轨：-2 => FE FF FF FF
- 长按类：持续时间毫秒数的十进制数转十六进制后取反
  + 长按 2647ms：2647 => 00 00 57 0A => 0A 57 00 00

#### 例子
长按
````
02 00 22 04 00 00 00 57 0A 00 00
````

滑箭
```
01 00 86 42 00 00 00 01 00 00 00
```

折线
```
61 00 F2 84 01 00 03 FE FF FF FF
22 00 F2 84 01 00 01 9E 00 00 00
21 00 90 85 01 00 01 01 00 00 00
22 00 90 85 01 00 02 9F 00 00 00
21 00 2F 86 01 00 02 FE FF FF FF
22 00 2F 86 01 00 00 9F 00 00 00
21 00 CE 86 01 00 00 01 00 00 00
22 00 CE 86 01 00 01 9F 00 00 00
21 00 6D 87 01 00 01 FF FF FF FF
22 00 6D 87 01 00 00 9E 00 00 00
A1 00 0B 88 01 00 00 01 00 00 00

61 00 AA 88 01 00 00 02 00 00 00
22 00 AA 88 01 00 02 9F 00 00 00
21 00 49 89 01 00 02 FF FF FF FF
22 00 49 89 01 00 01 9F 00 00 00
21 00 E8 89 01 00 01 02 00 00 00
22 00 E8 89 01 00 03 9E 00 00 00
21 00 86 8A 01 00 03 FF FF FF FF
22 00 86 8A 01 00 02 9F 00 00 00
21 00 25 8B 01 00 02 01 00 00 00
22 00 25 8B 01 00 03 9F 00 00 00
A1 00 C4 8B 01 00 03 FF FF FF FF
```